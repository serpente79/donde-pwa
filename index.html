<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Donde</title>
<link rel="manifest" href="manifest.json" />

<style>
body {
  font-family: Arial, sans-serif;
  padding: 20px;
  max-width: 700px;
  margin: auto;
  background: #f5f5f5;
}

h1 { text-align: center; }

.campo {
  margin-top: 10px;
}

.campo input {
  width: 100%;
  padding: 10px;
}

.boton-mic {
  margin-top: 5px;
  padding: 8px;
  width: 100%;
  background: #ff4d4d;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 16px;
}

button {
  padding: 10px;
  cursor: pointer;
  margin-top: 5px;
}

.item {
  background: white;
  padding: 10px;
  margin-top: 10px;
  border-radius: 8px;
}

small { color: gray; }

.topbar {
  margin-top: 15px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
</style>
</head>
<body>

<h1>Donde</h1>

<div class="campo">
  <input id="nombre" placeholder="Nombre de la cosa..." />
  <button class="boton-mic" onclick="iniciarDictado('nombre')">游꿏 cosa</button>
</div>

<div class="campo">
  <input id="ubicacion" placeholder="D칩nde est치 guardado..." />
  <button class="boton-mic" onclick="iniciarDictado('ubicacion')">游꿏 donde</button>
</div>

<button onclick="agregar()">Guardar</button>

<div class="topbar">
  <input id="buscar" placeholder="Buscar..." oninput="render()" />
  <select id="orden" onchange="render()">
    <option value="nuevo">M치s reciente</option>
    <option value="viejo">M치s antiguo</option>
    <option value="nombre">Ordenar por nombre</option>
  </select>
  <button onclick="exportar()">游닋 Exportar</button>
  <button onclick="document.getElementById('importFile').click()">游닌 Importar</button>
  <input type="file" id="importFile" accept=".json" style="display:none" onchange="importar(event)">
</div>

<div id="lista"></div>

<script>
let registros = JSON.parse(localStorage.getItem("registros")) || [];
const lista = document.getElementById("lista");
const nombre = document.getElementById("nombre");
const ubicacion = document.getElementById("ubicacion");
const buscarInput = document.getElementById("buscar");
const ordenSelect = document.getElementById("orden");

function guardar() {
  localStorage.setItem("registros", JSON.stringify(registros));
}

function agregar() {
  if (nombre.value.trim() === "" || ubicacion.value.trim() === "") return;

  const nuevo = {
    id: Date.now(),
    nombre: nombre.value.trim(),
    ubicacion: ubicacion.value.trim(),
    fecha: new Date().toISOString()
  };

  registros.push(nuevo);
  guardar();
  nombre.value = "";
  ubicacion.value = "";
  nombre.focus();
  render();
}

function borrar(id) {
  registros = registros.filter(r => r.id !== id);
  guardar();
  render();
}

function editar(id) {
  const item = registros.find(r => r.id === id);
  const nuevoNombre = prompt("Editar nombre:", item.nombre);
  const nuevaUbicacion = prompt("Editar ubicaci칩n:", item.ubicacion);

  if (nuevoNombre && nuevaUbicacion) {
    item.nombre = nuevoNombre.trim();
    item.ubicacion = nuevaUbicacion.trim();
    guardar();
    render();
  }
}

function render() {
  lista.innerHTML = "";

  let filtrados = registros.filter(r =>
    r.nombre.toLowerCase().includes(buscarInput.value.toLowerCase()) ||
    r.ubicacion.toLowerCase().includes(buscarInput.value.toLowerCase())
  );

  filtrados.sort((a, b) => {
    if (ordenSelect.value === "nuevo") {
      return new Date(b.fecha) - new Date(a.fecha);
    } else if (ordenSelect.value === "viejo") {
      return new Date(a.fecha) - new Date(b.fecha);
    } else {
      return a.nombre.localeCompare(b.nombre);
    }
  });

  filtrados.forEach(item => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <strong>${item.nombre}</strong><br>
      游늸 ${item.ubicacion}<br>
      <small>${new Date(item.fecha).toLocaleString()}</small><br>
      <button onclick="editar(${item.id})">Editar</button>
      <button onclick="borrar(${item.id})">Borrar</button>
    `;
    lista.appendChild(div);
  });
}

// 游꿏 Dictado para cualquier campo
function iniciarDictado(campo) {
  if (!('webkitSpeechRecognition' in window)) {
    alert("No soportado");
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.lang = "es-ES";
  recognition.start();

  recognition.onresult = function(event) {
    const texto = event.results[0][0].transcript;
    document.getElementById(campo).value = texto;
  };
}

// Enter para navegaci칩n y guardado
nombre.addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    ubicacion.focus();
  }
});

ubicacion.addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    agregar();
  }
});

// Exportar
function exportar() {
  const blob = new Blob([JSON.stringify(registros, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "donde-backup.json";
  a.click();
  URL.revokeObjectURL(url);
}

// Importar
function importar(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (Array.isArray(data)) {
        registros = data;
        guardar();
        render();
      }
    } catch {
      alert("Archivo inv치lido");
    }
  };
  reader.readAsText(file);
}

render();

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
